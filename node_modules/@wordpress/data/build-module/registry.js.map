{"version":3,"sources":["@wordpress/data/src/registry.js"],"names":["omit","without","mapValues","isObject","memize","createReduxStore","createCoreDataStore","createRegistry","storeConfigs","parent","stores","listeners","__experimentalListeningStores","Set","globalListener","forEach","listener","subscribe","push","select","storeNameOrDefinition","storeName","name","add","store","getSelectors","__experimentalMarkListeningStores","callback","ref","clear","result","call","current","Array","from","getResolveSelectors","selectors","selector","selectorName","args","Promise","resolve","hasFinished","hasFinishedResolution","getResult","apply","unsubscribe","maxSize","__experimentalResolveSelect","dispatch","getActions","withPlugins","attributes","attribute","key","registry","arguments","registerGenericStore","config","TypeError","register","instantiate","__experimentalSubscribeStore","handler","namespaces","use","registerStore","options","reducer","plugin","Object","entries"],"mappings":";;;;;;;AAAA;AACA;AACA;AACA,SAASA,IAAT,EAAeC,OAAf,EAAwBC,SAAxB,EAAmCC,QAAnC,QAAmD,QAAnD;AACA,OAAOC,MAAP,MAAmB,QAAnB;AAEA;AACA;AACA;;AACA,OAAOC,gBAAP,MAA6B,eAA7B;AACA,OAAOC,mBAAP,MAAgC,SAAhC;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACA,OAAO,SAASC,cAAT,GAA4D;AAAA,MAAnCC,YAAmC,uEAApB,EAAoB;AAAA,MAAhBC,MAAgB,uEAAP,IAAO;AAClE,MAAMC,MAAM,GAAG,EAAf;AACA,MAAIC,SAAS,GAAG,EAAhB;;AACA,MAAMC,6BAA6B,GAAG,IAAIC,GAAJ,EAAtC;AAEA;AACD;AACA;;;AACC,WAASC,cAAT,GAA0B;AACzBH,IAAAA,SAAS,CAACI,OAAV,CAAmB,UAAEC,QAAF;AAAA,aAAgBA,QAAQ,EAAxB;AAAA,KAAnB;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;;;AACC,MAAMC,SAAS,GAAG,SAAZA,SAAY,CAAED,QAAF,EAAgB;AACjCL,IAAAA,SAAS,CAACO,IAAV,CAAgBF,QAAhB;AAEA,WAAO,YAAM;AACZL,MAAAA,SAAS,GAAGV,OAAO,CAAEU,SAAF,EAAaK,QAAb,CAAnB;AACA,KAFD;AAGA,GAND;AAQA;AACD;AACA;AACA;AACA;AACA;AACA;AACA;;;AACC,WAASG,MAAT,CAAiBC,qBAAjB,EAAyC;AACxC,QAAMC,SAAS,GAAGlB,QAAQ,CAAEiB,qBAAF,CAAR,GACfA,qBAAqB,CAACE,IADP,GAEfF,qBAFH;;AAGAR,IAAAA,6BAA6B,CAACW,GAA9B,CAAmCF,SAAnC;;AACA,QAAMG,KAAK,GAAGd,MAAM,CAAEW,SAAF,CAApB;;AACA,QAAKG,KAAL,EAAa;AACZ,aAAOA,KAAK,CAACC,YAAN,EAAP;AACA;;AAED,WAAOhB,MAAM,IAAIA,MAAM,CAACU,MAAP,CAAeE,SAAf,CAAjB;AACA;;AAED,WAASK,iCAAT,CAA4CC,QAA5C,EAAsDC,GAAtD,EAA4D;AAC3DhB,IAAAA,6BAA6B,CAACiB,KAA9B;;AACA,QAAMC,MAAM,GAAGH,QAAQ,CAACI,IAAT,CAAe,IAAf,CAAf;AACAH,IAAAA,GAAG,CAACI,OAAJ,GAAcC,KAAK,CAACC,IAAN,CAAYtB,6BAAZ,CAAd;AACA,WAAOkB,MAAP;AACA;;AAED,MAAMK,mBAAmB,GAAG/B,MAAM,CACjC,UAAEgC,SAAF,EAAiB;AAChB,WAAOlC,SAAS,CACfF,IAAI,CAAEoC,SAAF,EAAa,CAChB,gBADgB,EAEhB,sBAFgB,EAGhB,uBAHgB,EAIhB,aAJgB,EAKhB,oBALgB,CAAb,CADW,EAQf,UAAEC,QAAF,EAAYC,YAAZ,EAA8B;AAC7B,aAAO,YAAe;AAAA,0CAAVC,IAAU;AAAVA,UAAAA,IAAU;AAAA;;AACrB,eAAO,IAAIC,OAAJ,CAAa,UAAEC,OAAF,EAAe;AAClC,cAAMC,WAAW,GAAG,SAAdA,WAAc;AAAA,mBACnBN,SAAS,CAACO,qBAAV,CACCL,YADD,EAECC,IAFD,CADmB;AAAA,WAApB;;AAKA,cAAMK,SAAS,GAAG,SAAZA,SAAY;AAAA,mBACjBP,QAAQ,CAACQ,KAAT,CAAgB,IAAhB,EAAsBN,IAAtB,CADiB;AAAA,WAAlB,CANkC,CASlC;;;AACA,cAAMT,MAAM,GAAGc,SAAS,EAAxB;;AACA,cAAKF,WAAW,EAAhB,EAAqB;AACpB,mBAAOD,OAAO,CAAEX,MAAF,CAAd;AACA;;AAED,cAAMgB,WAAW,GAAG7B,SAAS,CAAE,YAAM;AACpC,gBAAKyB,WAAW,EAAhB,EAAqB;AACpBI,cAAAA,WAAW;AACXL,cAAAA,OAAO,CAAEG,SAAS,EAAX,CAAP;AACA;AACD,WAL4B,CAA7B;AAMA,SArBM,CAAP;AAsBA,OAvBD;AAwBA,KAjCc,CAAhB;AAmCA,GArCgC,EAsCjC;AAAEG,IAAAA,OAAO,EAAE;AAAX,GAtCiC,CAAlC;AAyCA;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACC,WAASC,2BAAT,CAAsC5B,qBAAtC,EAA8D;AAC7D,WAAOe,mBAAmB,CAAEhB,MAAM,CAAEC,qBAAF,CAAR,CAA1B;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;;;AACC,WAAS6B,QAAT,CAAmB7B,qBAAnB,EAA2C;AAC1C,QAAMC,SAAS,GAAGlB,QAAQ,CAAEiB,qBAAF,CAAR,GACfA,qBAAqB,CAACE,IADP,GAEfF,qBAFH;AAGA,QAAMI,KAAK,GAAGd,MAAM,CAAEW,SAAF,CAApB;;AACA,QAAKG,KAAL,EAAa;AACZ,aAAOA,KAAK,CAAC0B,UAAN,EAAP;AACA;;AAED,WAAOzC,MAAM,IAAIA,MAAM,CAACwC,QAAP,CAAiB5B,SAAjB,CAAjB;AACA,GAjIiE,CAmIlE;AACA;AACA;AACA;;;AACA,WAAS8B,WAAT,CAAsBC,UAAtB,EAAmC;AAClC,WAAOlD,SAAS,CAAEkD,UAAF,EAAc,UAAEC,SAAF,EAAaC,GAAb,EAAsB;AACnD,UAAK,OAAOD,SAAP,KAAqB,UAA1B,EAAuC;AACtC,eAAOA,SAAP;AACA;;AACD,aAAO,YAAY;AAClB,eAAOE,QAAQ,CAAED,GAAF,CAAR,CAAgBT,KAAhB,CAAuB,IAAvB,EAA6BW,SAA7B,CAAP;AACA,OAFD;AAGA,KAPe,CAAhB;AAQA;AAED;AACD;AACA;AACA;AACA;AACA;;;AACC,WAASC,oBAAT,CAA+BH,GAA/B,EAAoCI,MAApC,EAA6C;AAC5C,QAAK,OAAOA,MAAM,CAACjC,YAAd,KAA+B,UAApC,EAAiD;AAChD,YAAM,IAAIkC,SAAJ,CAAe,wCAAf,CAAN;AACA;;AACD,QAAK,OAAOD,MAAM,CAACR,UAAd,KAA6B,UAAlC,EAA+C;AAC9C,YAAM,IAAIS,SAAJ,CAAe,sCAAf,CAAN;AACA;;AACD,QAAK,OAAOD,MAAM,CAACzC,SAAd,KAA4B,UAAjC,EAA8C;AAC7C,YAAM,IAAI0C,SAAJ,CAAe,qCAAf,CAAN;AACA;;AACDjD,IAAAA,MAAM,CAAE4C,GAAF,CAAN,GAAgBI,MAAhB;AACAA,IAAAA,MAAM,CAACzC,SAAP,CAAkBH,cAAlB;AACA;AAED;AACD;AACA;AACA;AACA;;;AACC,WAAS8C,QAAT,CAAmBpC,KAAnB,EAA2B;AAC1BiC,IAAAA,oBAAoB,CAAEjC,KAAK,CAACF,IAAR,EAAcE,KAAK,CAACqC,WAAN,CAAmBN,QAAnB,CAAd,CAApB;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;;;AACC,WAASO,4BAAT,CAAuCzC,SAAvC,EAAkD0C,OAAlD,EAA4D;AAC3D,QAAK1C,SAAS,IAAIX,MAAlB,EAA2B;AAC1B,aAAOA,MAAM,CAAEW,SAAF,CAAN,CAAoBJ,SAApB,CAA+B8C,OAA/B,CAAP;AACA,KAH0D,CAK3D;AACA;AACA;AACA;;;AACA,QAAK,CAAEtD,MAAP,EAAgB;AACf,aAAOQ,SAAS,CAAE8C,OAAF,CAAhB;AACA;;AAED,WAAOtD,MAAM,CAACqD,4BAAP,CAAqCzC,SAArC,EAAgD0C,OAAhD,CAAP;AACA;;AAED,MAAIR,QAAQ,GAAG;AACdE,IAAAA,oBAAoB,EAApBA,oBADc;AAEd/C,IAAAA,MAAM,EAANA,MAFc;AAGdsD,IAAAA,UAAU,EAAEtD,MAHE;AAGM;AACpBO,IAAAA,SAAS,EAATA,SAJc;AAKdE,IAAAA,MAAM,EAANA,MALc;AAMd6B,IAAAA,2BAA2B,EAA3BA,2BANc;AAOdC,IAAAA,QAAQ,EAARA,QAPc;AAQdgB,IAAAA,GAAG,EAAHA,GARc;AASdL,IAAAA,QAAQ,EAARA,QATc;AAUdlC,IAAAA,iCAAiC,EAAjCA,iCAVc;AAWdoC,IAAAA,4BAA4B,EAA5BA;AAXc,GAAf;AAcA;AACD;AACA;AACA;AACA;AACA;AACA;AACA;;AACCP,EAAAA,QAAQ,CAACW,aAAT,GAAyB,UAAE7C,SAAF,EAAa8C,OAAb,EAA0B;AAClD,QAAK,CAAEA,OAAO,CAACC,OAAf,EAAyB;AACxB,YAAM,IAAIT,SAAJ,CAAe,4BAAf,CAAN;AACA;;AAED,QAAMnC,KAAK,GAAGnB,gBAAgB,CAAEgB,SAAF,EAAa8C,OAAb,CAAhB,CAAuCN,WAAvC,CACbN,QADa,CAAd;AAGAE,IAAAA,oBAAoB,CAAEpC,SAAF,EAAaG,KAAb,CAApB;AACA,WAAOA,KAAK,CAACA,KAAb;AACA,GAVD,CA5NkE,CAwOlE;AACA;AACA;AACA;;;AACA,WAASyC,GAAT,CAAcI,MAAd,EAAsBF,OAAtB,EAAgC;AAC/BZ,IAAAA,QAAQ,mCACJA,QADI,GAEJc,MAAM,CAAEd,QAAF,EAAYY,OAAZ,CAFF,CAAR;AAKA,WAAOZ,QAAP;AACA;;AAEDE,EAAAA,oBAAoB,CAAE,WAAF,EAAenD,mBAAmB,CAAEiD,QAAF,CAAlC,CAApB;AAEAe,EAAAA,MAAM,CAACC,OAAP,CAAgB/D,YAAhB,EAA+BO,OAA/B,CAAwC;AAAA;AAAA,QAAIO,IAAJ;AAAA,QAAUoC,MAAV;;AAAA,WACvCH,QAAQ,CAACW,aAAT,CAAwB5C,IAAxB,EAA8BoC,MAA9B,CADuC;AAAA,GAAxC;;AAIA,MAAKjD,MAAL,EAAc;AACbA,IAAAA,MAAM,CAACQ,SAAP,CAAkBH,cAAlB;AACA;;AAED,SAAOqC,WAAW,CAAEI,QAAF,CAAlB;AACA","sourcesContent":["/**\n * External dependencies\n */\nimport { omit, without, mapValues, isObject } from 'lodash';\nimport memize from 'memize';\n\n/**\n * Internal dependencies\n */\nimport createReduxStore from './redux-store';\nimport createCoreDataStore from './store';\n\n/** @typedef {import('./types').WPDataStore} WPDataStore */\n\n/**\n * @typedef {Object} WPDataRegistry An isolated orchestrator of store registrations.\n *\n * @property {Function} registerGenericStore Given a namespace key and settings\n *                                           object, registers a new generic\n *                                           store.\n * @property {Function} registerStore        Given a namespace key and settings\n *                                           object, registers a new namespace\n *                                           store.\n * @property {Function} subscribe            Given a function callback, invokes\n *                                           the callback on any change to state\n *                                           within any registered store.\n * @property {Function} select               Given a namespace key, returns an\n *                                           object of the  store's registered\n *                                           selectors.\n * @property {Function} dispatch             Given a namespace key, returns an\n *                                           object of the store's registered\n *                                           action dispatchers.\n */\n\n/**\n * @typedef {Object} WPDataPlugin An object of registry function overrides.\n *\n * @property {Function} registerStore registers store.\n */\n\n/**\n * Creates a new store registry, given an optional object of initial store\n * configurations.\n *\n * @param {Object}  storeConfigs Initial store configurations.\n * @param {Object?} parent       Parent registry.\n *\n * @return {WPDataRegistry} Data registry.\n */\nexport function createRegistry( storeConfigs = {}, parent = null ) {\n\tconst stores = {};\n\tlet listeners = [];\n\tconst __experimentalListeningStores = new Set();\n\n\t/**\n\t * Global listener called for each store's update.\n\t */\n\tfunction globalListener() {\n\t\tlisteners.forEach( ( listener ) => listener() );\n\t}\n\n\t/**\n\t * Subscribe to changes to any data.\n\t *\n\t * @param {Function}   listener Listener function.\n\t *\n\t * @return {Function}           Unsubscribe function.\n\t */\n\tconst subscribe = ( listener ) => {\n\t\tlisteners.push( listener );\n\n\t\treturn () => {\n\t\t\tlisteners = without( listeners, listener );\n\t\t};\n\t};\n\n\t/**\n\t * Calls a selector given the current state and extra arguments.\n\t *\n\t * @param {string|WPDataStore} storeNameOrDefinition Unique namespace identifier for the store\n\t *                                                   or the store definition.\n\t *\n\t * @return {*} The selector's returned value.\n\t */\n\tfunction select( storeNameOrDefinition ) {\n\t\tconst storeName = isObject( storeNameOrDefinition )\n\t\t\t? storeNameOrDefinition.name\n\t\t\t: storeNameOrDefinition;\n\t\t__experimentalListeningStores.add( storeName );\n\t\tconst store = stores[ storeName ];\n\t\tif ( store ) {\n\t\t\treturn store.getSelectors();\n\t\t}\n\n\t\treturn parent && parent.select( storeName );\n\t}\n\n\tfunction __experimentalMarkListeningStores( callback, ref ) {\n\t\t__experimentalListeningStores.clear();\n\t\tconst result = callback.call( this );\n\t\tref.current = Array.from( __experimentalListeningStores );\n\t\treturn result;\n\t}\n\n\tconst getResolveSelectors = memize(\n\t\t( selectors ) => {\n\t\t\treturn mapValues(\n\t\t\t\tomit( selectors, [\n\t\t\t\t\t'getIsResolving',\n\t\t\t\t\t'hasStartedResolution',\n\t\t\t\t\t'hasFinishedResolution',\n\t\t\t\t\t'isResolving',\n\t\t\t\t\t'getCachedResolvers',\n\t\t\t\t] ),\n\t\t\t\t( selector, selectorName ) => {\n\t\t\t\t\treturn ( ...args ) => {\n\t\t\t\t\t\treturn new Promise( ( resolve ) => {\n\t\t\t\t\t\t\tconst hasFinished = () =>\n\t\t\t\t\t\t\t\tselectors.hasFinishedResolution(\n\t\t\t\t\t\t\t\t\tselectorName,\n\t\t\t\t\t\t\t\t\targs\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tconst getResult = () =>\n\t\t\t\t\t\t\t\tselector.apply( null, args );\n\n\t\t\t\t\t\t\t// trigger the selector (to trigger the resolver)\n\t\t\t\t\t\t\tconst result = getResult();\n\t\t\t\t\t\t\tif ( hasFinished() ) {\n\t\t\t\t\t\t\t\treturn resolve( result );\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tconst unsubscribe = subscribe( () => {\n\t\t\t\t\t\t\t\tif ( hasFinished() ) {\n\t\t\t\t\t\t\t\t\tunsubscribe();\n\t\t\t\t\t\t\t\t\tresolve( getResult() );\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} );\n\t\t\t\t\t\t} );\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t);\n\t\t},\n\t\t{ maxSize: 1 }\n\t);\n\n\t/**\n\t * Given the name of a registered store, returns an object containing the store's\n\t * selectors pre-bound to state so that you only need to supply additional arguments,\n\t * and modified so that they return promises that resolve to their eventual values,\n\t * after any resolvers have ran.\n\t *\n\t * @param {string|WPDataStore} storeNameOrDefinition Unique namespace identifier for the store\n\t *                                                   or the store definition.\n\t *\n\t * @return {Object} Each key of the object matches the name of a selector.\n\t */\n\tfunction __experimentalResolveSelect( storeNameOrDefinition ) {\n\t\treturn getResolveSelectors( select( storeNameOrDefinition ) );\n\t}\n\n\t/**\n\t * Returns the available actions for a part of the state.\n\t *\n\t * @param {string|WPDataStore} storeNameOrDefinition Unique namespace identifier for the store\n\t *                                                   or the store definition.\n\t *\n\t * @return {*} The action's returned value.\n\t */\n\tfunction dispatch( storeNameOrDefinition ) {\n\t\tconst storeName = isObject( storeNameOrDefinition )\n\t\t\t? storeNameOrDefinition.name\n\t\t\t: storeNameOrDefinition;\n\t\tconst store = stores[ storeName ];\n\t\tif ( store ) {\n\t\t\treturn store.getActions();\n\t\t}\n\n\t\treturn parent && parent.dispatch( storeName );\n\t}\n\n\t//\n\t// Deprecated\n\t// TODO: Remove this after `use()` is removed.\n\t//\n\tfunction withPlugins( attributes ) {\n\t\treturn mapValues( attributes, ( attribute, key ) => {\n\t\t\tif ( typeof attribute !== 'function' ) {\n\t\t\t\treturn attribute;\n\t\t\t}\n\t\t\treturn function () {\n\t\t\t\treturn registry[ key ].apply( null, arguments );\n\t\t\t};\n\t\t} );\n\t}\n\n\t/**\n\t * Registers a generic store.\n\t *\n\t * @param {string} key    Store registry key.\n\t * @param {Object} config Configuration (getSelectors, getActions, subscribe).\n\t */\n\tfunction registerGenericStore( key, config ) {\n\t\tif ( typeof config.getSelectors !== 'function' ) {\n\t\t\tthrow new TypeError( 'config.getSelectors must be a function' );\n\t\t}\n\t\tif ( typeof config.getActions !== 'function' ) {\n\t\t\tthrow new TypeError( 'config.getActions must be a function' );\n\t\t}\n\t\tif ( typeof config.subscribe !== 'function' ) {\n\t\t\tthrow new TypeError( 'config.subscribe must be a function' );\n\t\t}\n\t\tstores[ key ] = config;\n\t\tconfig.subscribe( globalListener );\n\t}\n\n\t/**\n\t * Registers a new store definition.\n\t *\n\t * @param {WPDataStore} store Store definition.\n\t */\n\tfunction register( store ) {\n\t\tregisterGenericStore( store.name, store.instantiate( registry ) );\n\t}\n\n\t/**\n\t * Subscribe handler to a store.\n\t *\n\t * @param {string[]} storeName The store name.\n\t * @param {Function} handler   The function subscribed to the store.\n\t * @return {Function} A function to unsubscribe the handler.\n\t */\n\tfunction __experimentalSubscribeStore( storeName, handler ) {\n\t\tif ( storeName in stores ) {\n\t\t\treturn stores[ storeName ].subscribe( handler );\n\t\t}\n\n\t\t// Trying to access a store that hasn't been registered,\n\t\t// this is a pattern rarely used but seen in some places.\n\t\t// We fallback to regular `subscribe` here for backward-compatibility for now.\n\t\t// See https://github.com/WordPress/gutenberg/pull/27466 for more info.\n\t\tif ( ! parent ) {\n\t\t\treturn subscribe( handler );\n\t\t}\n\n\t\treturn parent.__experimentalSubscribeStore( storeName, handler );\n\t}\n\n\tlet registry = {\n\t\tregisterGenericStore,\n\t\tstores,\n\t\tnamespaces: stores, // TODO: Deprecate/remove this.\n\t\tsubscribe,\n\t\tselect,\n\t\t__experimentalResolveSelect,\n\t\tdispatch,\n\t\tuse,\n\t\tregister,\n\t\t__experimentalMarkListeningStores,\n\t\t__experimentalSubscribeStore,\n\t};\n\n\t/**\n\t * Registers a standard `@wordpress/data` store.\n\t *\n\t * @param {string} storeName  Unique namespace identifier.\n\t * @param {Object} options    Store description (reducer, actions, selectors, resolvers).\n\t *\n\t * @return {Object} Registered store object.\n\t */\n\tregistry.registerStore = ( storeName, options ) => {\n\t\tif ( ! options.reducer ) {\n\t\t\tthrow new TypeError( 'Must specify store reducer' );\n\t\t}\n\n\t\tconst store = createReduxStore( storeName, options ).instantiate(\n\t\t\tregistry\n\t\t);\n\t\tregisterGenericStore( storeName, store );\n\t\treturn store.store;\n\t};\n\n\t//\n\t// TODO:\n\t// This function will be deprecated as soon as it is no longer internally referenced.\n\t//\n\tfunction use( plugin, options ) {\n\t\tregistry = {\n\t\t\t...registry,\n\t\t\t...plugin( registry, options ),\n\t\t};\n\n\t\treturn registry;\n\t}\n\n\tregisterGenericStore( 'core/data', createCoreDataStore( registry ) );\n\n\tObject.entries( storeConfigs ).forEach( ( [ name, config ] ) =>\n\t\tregistry.registerStore( name, config )\n\t);\n\n\tif ( parent ) {\n\t\tparent.subscribe( globalListener );\n\t}\n\n\treturn withPlugins( registry );\n}\n"]}